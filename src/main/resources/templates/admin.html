<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard</title>

    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container mt-5">

    <div class="card shadow p-4">
        <h2 class="text-center mb-4">Driver Performance Dashboard</h2>

        <!-- Driver Table -->
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
            <tr>
                <th>Driver ID</th>
                <th>Average Score</th>
                <th>Feedback Count</th>
                <th>Last Updated</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="driver : ${drivers}">
                <td th:text="${driver.driverId}"></td>
                <td th:text="${driver.averageScore}"></td>
                <td th:text="${driver.feedbackCount}"></td>
                <td th:text="${driver.lastUpdated}"></td>
            </tr>
            </tbody>
        </table>

        <hr class="my-4">

        <!-- Alerts Table -->
        <h4 class="text-danger">Generated Alerts</h4>

        <table class="table table-bordered table-striped">
            <thead class="table-danger">
            <tr>
                <th>Driver ID</th>
                <th>Average Score</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="alert : ${alerts}">
                <td th:text="${alert.driverId}"></td>
                <td th:text="${alert.averageScore}"></td>
            </tr>
            </tbody>
        </table>

        <hr class="my-4">

        <!-- Charts Section -->
        <h4>Driver Performance Charts</h4>

        <div class="row">
            <div class="col-md-6 mb-4" th:each="driver : ${drivers}">
                <div class="card p-3 shadow-sm">
                    <h6 class="text-center"
                        th:text="'Driver: ' + ${driver.driverId}"></h6>
                    <canvas th:id="'chart_' + ${driver.driverId}"
                            height="200"></canvas>
                </div>
            </div>
        </div>

        <hr class="my-4">

        <div class="text-center">
            <a href="/feedback-form" class="btn btn-secondary">
                Back to Feedback Form
            </a>
        </div>
    </div>

</div>

<!-- Chart Script -->
<script th:inline="javascript">
    /*<![CDATA[*/

    const drivers = [[${drivers}]];

    drivers.forEach(driver => {

        const canvasId = 'chart_' + driver.driverId;
        const ctx = document.getElementById(canvasId).getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Average Score'],
                datasets: [{
                    label: 'Score',
                    data: [driver.averageScore],
                    backgroundColor:
                        driver.averageScore < 2.5
                            ? 'rgba(220,53,69,0.7)'  // red if low
                            : 'rgba(25,135,84,0.7)', // green if good
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 5
                    }
                }
            }
        });

    });

    /*]]>*/
</script>

</body>
</html>